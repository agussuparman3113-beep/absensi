<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Aplikasi Absensi Scan Barcode (LocalStorage)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- html5-qrcode library for barcode scanning -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- qrcode.js for generating QR codes -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <!-- SheetJS (xlsx) for Excel export & import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- JSZip for zip (optional, kept for compatibility) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

    <style>
        body { font-family: 'Inter', sans-serif; }
        #reader { border: 2px solid #3b82f6; border-radius: .5rem; overflow: hidden; }
        .scan-success { box-shadow: 0 0 20px 5px rgba(74, 222, 128, 0.7); transition: box-shadow .3s ease-in-out; }
        #qrcode-display-area canvas { max-width: 100%; height: auto; border-radius: 8px; }
        .inline-qr-code > img { width: 100%; height: 100%; }
        .qr-code-button { cursor: pointer; background: none; border: none; padding: 0; }
        #large-qr-code-container img, #large-qr-code-container canvas { margin: auto; }
        #toast-notification.show { opacity: 1; transform: translateY(0); }
    </style>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<link rel="icon" href="icons/icon-192.png">
</head>
<body class="bg-gray-900 text-white antialiased">

<div class="container mx-auto max-w-5xl p-4 sm:p-6 lg:p-8">
    <header class="text-center mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">Aplikasi Absensi Barcode (LocalStorage)</h1>
        <p class="text-gray-400 mt-2">Pindai absensi dan kelola data siswa â€” semua tersimpan di browser Anda.</p>
    </header>

    <main class="bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8">
        <div class="mb-4 border-b border-gray-700">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" role="tablist">
                <li class="mr-2" role="presentation"><button class="inline-block p-4 border-b-2 rounded-t-lg" id="scanner-tab" type="button" role="tab">Pemindai</button></li>
                <li class="mr-2" role="presentation"><button class="inline-block p-4 border-b-2 rounded-t-lg" id="attendance-tab" type="button" role="tab">Daftar Kehadiran</button></li>
                <li class="mr-2" role="presentation"><button class="inline-block p-4 border-b-2 rounded-t-lg" id="students-tab" type="button" role="tab">Data Siswa</button></li>
            </ul>
        </div>

        <div>
            <!-- Scanner -->
            <div id="scanner-content" role="tabpanel">
                <h2 class="text-xl font-semibold mb-4">Area Pemindai</h2>
                <div id="reader" class="w-full max-w-md mx-auto aspect-square bg-gray-900 rounded-lg"></div>
                <div id="status-container" class="mt-4 max-w-md mx-auto text-center p-3 rounded-lg bg-gray-700 min-h-[50px] flex items-center justify-center">
                    <span id="status-message" class="text-gray-300">Mengaktifkan kamera...</span>
                </div>
            </div>

            <!-- Attendance -->
            <div id="attendance-content" role="tabpanel" class="hidden">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <div class="flex items-center gap-2">
                        <label for="class-select" class="text-sm font-medium">Pilih Kelas:</label>
                        <select id="class-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2"></select>
                    </div>

                    <div class="flex gap-2">
                        <button id="exportButton" class="text-sm bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>Export ke Excel</button>
                        <button id="clearButton" class="text-sm bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-lg">Bersihkan Absen</button>
                    </div>
                </div>

                <div class="bg-gray-900 rounded-lg h-[450px] overflow-y-auto">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0">
                            <tr>
                                <th scope="col" class="px-4 py-3 w-1/12">No.</th>
                                <th scope="col" class="px-4 py-3 w-5/12">Nama Siswa</th>
                                <th scope="col" class="px-4 py-3 w-3/12">Keterangan</th>
                                <th scope="col" class="px-4 py-3 w-3/12">Waktu Hadir</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-body" class="divide-y divide-gray-700"></tbody>
                    </table>
                </div>
            </div>

            <!-- Students -->
            <div id="students-content" role="tabpanel" class="hidden">
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-xl font-semibold mb-4">Tambah Siswa Baru</h2>
                        <form id="add-student-form" class="space-y-4">
                            <div>
                                <label for="student-name" class="block mb-2 text-sm font-medium">Nama Siswa</label>
                                <input type="text" id="student-name" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg w-full p-2.5" placeholder="Contoh: Budi Santoso" required>
                            </div>
                            <div>
                                <label for="student-class" class="block mb-2 text-sm font-medium">Pilih Kelas</label>
                                <select id="student-class" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg w-full p-2.5"></select>
                            </div>
                            <button type="submit" class="w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Tambah Siswa</button>
                        </form>

                        <div class="mt-8">
                            <h2 class="text-xl font-semibold mb-4">Import Siswa dari Excel</h2>
                            <div class="space-y-4 p-4 border border-dashed border-gray-600 rounded-lg">
                                <p class="text-xs text-gray-400">
                                    <strong>Format Wajib:</strong><br>
                                    - Kolom A: Nama Siswa<br>
                                    - Kolom B: Nama Kelas (contoh: KELAS_7A atau "7A" akan otomatis diubah)
                                </p>
                                <div>
                                    <label for="import-file" class="sr-only">Pilih file</label>
                                    <input type="file" id="import-file" accept=".xlsx, .xls" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer">
                                </div>
                                <button id="import-button" class="w-full text-white bg-teal-600 hover:bg-teal-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>Import Data</button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                            <h2 class="text-xl font-semibold">Daftar Siswa Terdaftar</h2>
                            <button id="export-students-button" class="text-sm bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>Export & Cetak Barcode</button>
                        </div>

                        <div class="flex items-center gap-2 mb-4">
                            <label for="view-class-select" class="text-sm font-medium">Tampilkan Kelas:</label>
                            <select id="view-class-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg w-full p-2"></select>
                        </div>

                        <div class="bg-gray-900 rounded-lg h-[380px] overflow-y-auto">
                            <table class="w-full text-sm text-left text-gray-400">
                                <thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0">
                                    <tr>
                                        <th scope="col" class="px-4 py-3">Nama Siswa</th>
                                        <th scope="col" class="px-4 py-3">Barcode</th>
                                        <th scope="col" class="px-4 py-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="student-list-body" class="divide-y divide-gray-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center mt-8 text-gray-500 text-sm">
        <p>Dibuat dengan <span class="text-red-500">&hearts;</span> untuk pencatatan yang lebih mudah â€” data tersimpan di browser Anda.</p>
    </footer>
</div>

<!-- Modal Large QR -->
<div id="qr-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center relative max-w-xs w-full">
        <button id="close-modal-button" class="absolute -top-2 -right-2 text-gray-200 bg-gray-900 rounded-full h-8 w-8 flex items-center justify-center text-xl font-bold hover:bg-red-600">&times;</button>
        <div id="large-qr-code-container" class="mb-4 bg-white p-4 rounded-md inline-block"></div>
        <p id="modal-student-name" class="text-lg font-semibold text-white"></p>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center max-w-sm w-full">
        <p id="confirm-modal-message" class="text-lg text-white mb-6"></p>
        <div class="flex justify-center gap-4">
            <button id="confirm-modal-cancel" class="px-6 py-2 rounded-lg bg-gray-600 hover:bg-gray-700 text-white font-medium">Batal</button>
            <button id="confirm-modal-ok" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-medium">Ya, Lanjutkan</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast-notification" class="fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg text-sm transition-all duration-300 opacity-0 transform translate-y-4 z-50">
    <span id="toast-message"></span>
</div>

<script>
/* ==============================
   Konstanta & Inisialisasi Data
   ============================== */
const INITIAL_STUDENT_DATA = {
    'KELAS_7A': ['Ahmad Subarjo', 'Budi Santoso'],
    'KELAS_7B': ['Fajar Nugroho', 'Gita Permata'],
    'KELAS_8A': ['Kartika Sari', 'Lina Marlina'],
    'KELAS_8B': ['Putri Amelia', 'Qori Ramadhan'],
    'KELAS_9A': ['Umar Bakri', 'Vina Panduwinata'],
    'KELAS_9B': ['Anisa Rahma', 'Bayu Skak']
};

const STUDENT_KEY = 'absensi_students_v1';
const ATTENDANCE_KEY = 'absensi_records_v1'; // array of { userId, dateISO, timeStr }

const DOM = {
    tabs: [document.getElementById('scanner-tab'), document.getElementById('attendance-tab'), document.getElementById('students-tab')],
    contents: [document.getElementById('scanner-content'), document.getElementById('attendance-content'), document.getElementById('students-content')],
    readerDiv: document.getElementById('reader'),
    statusMessage: document.getElementById('status-message'),
    classSelect: document.getElementById('class-select'),
    attendanceBody: document.getElementById('attendance-body'),
    clearButton: document.getElementById('clearButton'),
    exportButton: document.getElementById('exportButton'),
    addStudentForm: document.getElementById('add-student-form'),
    studentNameInput: document.getElementById('student-name'),
    studentClassSelect: document.getElementById('student-class'),
    viewClassSelect: document.getElementById('view-class-select'),
    studentListBody: document.getElementById('student-list-body'),
    importFile: document.getElementById('import-file'),
    importButton: document.getElementById('import-button'),
    exportStudentsButton: document.getElementById('export-students-button'),
    qrModal: document.getElementById('qr-modal'),
    closeModalButton: document.getElementById('close-modal-button'),
    largeQrCodeContainer: document.getElementById('large-qr-code-container'),
    modalStudentName: document.getElementById('modal-student-name'),
    confirmModal: document.getElementById('confirm-modal'),
    confirmModalMessage: document.getElementById('confirm-modal-message'),
    confirmModalOK: document.getElementById('confirm-modal-ok'),
    confirmModalCancel: document.getElementById('confirm-modal-cancel'),
    toast: document.getElementById('toast-notification'),
    toastMessage: document.getElementById('toast-message')
};

let html5QrcodeScanner = null;
let lastScanTime = 0;
const SCAN_COOLDOWN = 1200; // ms
let confirmPromiseResolve = null;

/* ======================
   LocalStorage Utilities
   ====================== */
function loadStudents() {
    const raw = localStorage.getItem(STUDENT_KEY);
    if (!raw) {
        localStorage.setItem(STUDENT_KEY, JSON.stringify(INITIAL_STUDENT_DATA));
        return JSON.parse(JSON.stringify(INITIAL_STUDENT_DATA));
    }
    try {
        return JSON.parse(raw);
    } catch (e) {
        localStorage.setItem(STUDENT_KEY, JSON.stringify(INITIAL_STUDENT_DATA));
        return JSON.parse(JSON.stringify(INITIAL_STUDENT_DATA));
    }
}

function saveStudents(data) {
    localStorage.setItem(STUDENT_KEY, JSON.stringify(data));
}

function loadAttendance() {
    const raw = localStorage.getItem(ATTENDANCE_KEY);
    if (!raw) return [];
    try { return JSON.parse(raw); } catch (e) { return []; }
}

function saveAttendanceRecords(arr) {
    localStorage.setItem(ATTENDANCE_KEY, JSON.stringify(arr));
}

/* ======================
   Scanner & Scan Handler
   ====================== */
function onScanSuccess(decodedText) {
    const now = Date.now();
    if (now - lastScanTime < SCAN_COOLDOWN) return;
    lastScanTime = now;

    DOM.readerDiv.classList.add('scan-success');
    setTimeout(() => DOM.readerDiv.classList.remove('scan-success'), 500);

    // short beep
    try {
        new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU' + Array(1e3).join('123')).play();
    } catch(e){ /* ignore */ }
    if (navigator.vibrate) navigator.vibrate(90);

    DOM.statusMessage.textContent = `Sukses! ID: ${decodedText}`;
    localSaveAttendance(decodedText);
}

function startScan() {
    if (!html5QrcodeScanner) {
        try {
            html5QrcodeScanner = new Html5Qrcode("reader");
        } catch (err) {
            DOM.statusMessage.textContent = "Error: Gagal memuat library scanner.";
            return;
        }
    }
    if (html5QrcodeScanner.isScanning) return;
    html5QrcodeScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onScanSuccess,
        (err) => { /* progress */ }
    ).then(() => { DOM.statusMessage.textContent = "Arahkan kamera ke barcode..."; })
    .catch(err => { DOM.statusMessage.textContent = "Error: Gagal memulai kamera."; console.error(err); });
}

function stopScan() {
    if (html5QrcodeScanner && html5QrcodeScanner.isScanning) {
        html5QrcodeScanner.stop().catch(err => console.warn("Gagal menghentikan scanner.", err));
    }
}

/* ======================
   Attendance (Local)
   ====================== */
function localSaveAttendance(scannedId) {
    const students = loadStudents();
    const allNames = Object.values(students).flat();
    if (!allNames.includes(scannedId)) {
        DOM.statusMessage.textContent = `Error: Siswa "${scannedId}" tidak terdaftar.`;
        showToast(`Siswa "${scannedId}" tidak terdaftar.`, true);
        return;
    }

    const records = loadAttendance();
    const todayISO = (new Date()).toISOString().slice(0,10);
    const timeStr = new Date().toLocaleTimeString('id-ID');

    // Cegah duplikat hari yang sama
    const already = records.find(r => r.userId === scannedId && r.dateISO === todayISO);
    if (already) {
        showToast(`${scannedId} sudah absen hari ini.`);
        return;
    }
    records.push({ userId: scannedId, dateISO: todayISO, timeStr });
    saveAttendanceRecords(records);
    showToast(`Absensi ${scannedId} tercatat.`);
    renderAttendance();
}

/* ======================
   Render / UI Functions
   ====================== */
function populateClassSelects() {
    const students = loadStudents();
    const classNames = Object.keys(students).sort();
    const createOption = (val) => `<option value="${val}">${val.replace('KELAS_', 'Kelas ')}</option>`;
    const optionsHtml = ['<option value="">- Pilih Kelas -</option>', ...classNames.map(createOption)].join('');
    [DOM.classSelect, DOM.studentClassSelect, DOM.viewClassSelect].forEach(sel => sel.innerHTML = optionsHtml);
    // set defaults if empty
    if (!DOM.viewClassSelect.value && classNames.length) DOM.viewClassSelect.value = classNames[0];
    if (!DOM.classSelect.value && classNames.length) DOM.classSelect.value = classNames[0];
}

function renderAttendance() {
    const selectedClass = DOM.classSelect.value;
    const studentList = (selectedClass ? (loadStudents()[selectedClass] || []) : []);
    DOM.exportButton.disabled = !selectedClass || !studentList || studentList.length === 0;

    if (!selectedClass || !studentList) {
        DOM.attendanceBody.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-gray-500">Pilih kelas...</td></tr>`;
        return;
    }

    const todayISO = (new Date()).toISOString().slice(0,10);
    const presentMap = new Map(loadAttendance().filter(r => r.dateISO === todayISO).map(r => [r.userId, r.timeStr]));

    DOM.attendanceBody.innerHTML = studentList.sort().map((name, i) => {
        const isPresent = presentMap.has(name);
        return `<tr class="bg-gray-800 border-b border-gray-700">
            <td class="px-4 py-3">${i+1}</td>
            <td class="px-4 py-3 font-bold">${name}</td>
            <td class="px-4 py-3 font-semibold">${isPresent ? '<span class="text-green-400">HADIR</span>' : '<span class="text-red-400">ALPA</span>'}</td>
            <td class="px-4 py-3">${isPresent ? presentMap.get(name) : '-'}</td>
        </tr>`;
    }).join('');
}

function renderStudentList() {
    const selectedClass = DOM.viewClassSelect.value;
    const students = loadStudents()[selectedClass] || [];
    DOM.exportStudentsButton.disabled = !(students && students.length > 0);

    const tbody = DOM.studentListBody;
    tbody.innerHTML = '';
    if (!selectedClass) { tbody.innerHTML = `<tr><td colspan="3" class="px-4 py-6 text-center text-gray-500">Pilih kelas...</td></tr>`; return; }
    if (!students.length) { tbody.innerHTML = `<tr><td colspan="3" class="px-4 py-6 text-center text-gray-500">Belum ada siswa.</td></tr>`; return; }

    students.sort().forEach(name => {
        const tr = document.createElement('tr');
        const qrId = `qr-${name.replace(/[^a-zA-Z0-9]/g, "")}-${Math.random().toString(36).substr(2,9)}`;
        tr.innerHTML = `<td class="px-4 py-2 font-medium align-middle">${name}</td>
            <td class="px-4 py-2"><button data-name="${name}" class="qr-code-button"><div id="${qrId}" class="w-12 h-12 bg-white p-1 rounded inline-qr-code pointer-events-none"></div></button></td>
            <td class="px-4 py-2 align-middle"><button data-name="${name}" class="delete-student-button text-red-500 hover:text-red-400 text-xs font-bold">HAPUS</button></td>`;
        tbody.appendChild(tr);
        setTimeout(() => {
            const qrContainer = document.getElementById(qrId);
            if (qrContainer) new QRCode(qrContainer, { text: name, width: 40, height: 40, colorDark: "#000", colorLight: "#fff" });
        }, 0);
    });
}

/* ======================
   Student CRUD (Local)
   ====================== */
async function handleAddStudent(e) {
    e.preventDefault();
    const name = DOM.studentNameInput.value.trim();
    let className = DOM.studentClassSelect.value;
    if (!name || !className) return;

    // normalize class: allow user to type "7A" or "KELAS_7A"
    if (!/^KELAS_/i.test(className)) {
        className = className.toUpperCase().replace(/\s+/g, '_');
        if (!/^KELAS_/.test(className)) className = 'KELAS_' + className;
    }

    const students = loadStudents();
    if (!students[className]) students[className] = [];
    if (students[className].includes(name)) { showToast(`Siswa ${name} sudah ada di ${className}`, true); return; }
    students[className].push(name);
    students[className] = Array.from(new Set(students[className])).sort();
    saveStudents(students);
    DOM.studentNameInput.value = '';
    populateClassSelects();
    renderStudentList();
    renderAttendance();
    showToast(`Siswa ${name} berhasil ditambahkan.`);
}

async function handleDeleteStudent(name) {
    const className = DOM.viewClassSelect.value;
    if (!name || !className) return;
    const confirmed = await showConfirm(`Hapus siswa "${name}" dari ${className}?`);
    if (!confirmed) return;
    const students = loadStudents();
    students[className] = (students[className] || []).filter(s => s !== name);
    saveStudents(students);
    renderStudentList();
    renderAttendance();
    showToast(`Siswa ${name} berhasil dihapus.`);
}

/* ======================
   Import / Export
   ====================== */
function handleImport() {
    const file = DOM.importFile.files[0];
    if (!file) return;
    DOM.importButton.textContent = 'Memproses...'; DOM.importButton.disabled = true;

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            const studentsByClass = {};
            let processedRows = 0;
            jsonData.forEach((row, idx) => {
                if (idx === 0) return; // skip header if present
                const name = row[0] ? String(row[0]).trim() : '';
                let className = row[1] ? String(row[1]).trim().toUpperCase().replace(/\s+/g, '_') : '';
                if (!name || !className) return;
                if (!/^KELAS_/.test(className)) className = 'KELAS_' + className;
                if (!studentsByClass[className]) studentsByClass[className] = [];
                studentsByClass[className].push(name);
                processedRows++;
            });

            if (processedRows === 0) throw new Error("Tidak ada data siswa yang valid ditemukan di file.");

            // merge with existing students
            const students = loadStudents();
            for (const cls in studentsByClass) {
                if (!students[cls]) students[cls] = [];
                const set = new Set([...students[cls], ...studentsByClass[cls]]);
                students[cls] = Array.from(set).sort();
            }
            saveStudents(students);
            populateClassSelects();
            renderStudentList();
            showToast(`${processedRows} data siswa berhasil diimpor.`);
        } catch (err) {
            console.error(err);
            showToast(`Gagal mengimpor: ${err.message}`, true);
        } finally {
            DOM.importButton.textContent = 'Import Data'; DOM.importButton.disabled = true; DOM.importFile.value = '';
        }
    };
    reader.readAsArrayBuffer(file);
}

function exportToExcel() {
    const className = DOM.classSelect.value;
    const students = (className ? (loadStudents()[className] || []) : []);
    if (!className || !students.length) return;

    const header = ['No.', 'Nama Siswa', 'Keterangan', 'Waktu Hadir'];
    const dataRows = Array.from(DOM.attendanceBody.querySelectorAll('tr')).map(row => Array.from(row.querySelectorAll('td')).map(col => col.innerText));
    const data = [header, ...dataRows];
    const worksheet = XLSX.utils.aoa_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Absensi");
    worksheet['!cols'] = [{wch:5},{wch:30},{wch:15},{wch:15}];
    const filename = `absensi_${className}_${(new Date()).toISOString().slice(0,10)}.xlsx`;
    XLSX.writeFile(workbook, filename);
}

function exportStudentDataWithQRCodes() {
    const className = DOM.viewClassSelect.value;
    const students = loadStudents()[className] || [];
    if (!className || !students.length) { showToast("Pilih kelas yang ada siswanya untuk diekspor.", true); return; }

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Data Siswa & Barcode - ${className.replace('KELAS_', 'Kelas ')}</title>
            <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"><\/script>
            <style>
                body { font-family: sans-serif; margin: 20px; }
                h1 { text-align: center; }
                .student-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
                .student-card { border: 1px solid #ccc; padding: 10px; text-align: center; border-radius: 8px; page-break-inside: avoid; }
                .qr-code { margin: 10px auto; display: inline-block; }
                .student-name { font-weight: bold; margin-top: 5px; }
                .print-button { position: fixed; top: 10px; right: 10px; padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
                @media print { .print-button { display: none; } body { margin: 0.5cm; } h1 { margin-bottom: 1cm; } }
            </style>
        <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<link rel="icon" href="icons/icon-192.png">
</head>
        <body>
            <h1>Data Siswa & Barcode - ${className.replace('KELAS_', 'Kelas ')}</h1>
            <button class="print-button" onclick="window.print()">Cetak Halaman Ini</button>
            <div class="student-grid">
                ${students.sort().map((name, i) => `
                    <div class="student-card">
                        <div id="qr-${i}" class="qr-code"></div>
                        <div class="student-name">${i+1}. ${name}</div>
                    </div>
                `).join('')}
            </div>
            <script>
                window.onload = function() {
                    const students = ${JSON.stringify(students.sort())};
                    students.forEach((name, idx) => {
                        new QRCode(document.getElementById('qr-' + idx), { text: name, width: 128, height: 128 });
                    });
                };
            <\/script>
        <script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').then(reg => {
      console.log('SW registered', reg.scope);
    }).catch(err => console.warn('SW failed', err));
  });
}
</script>
</body>
        </html>
    `);
    printWindow.document.close();
}

/* ======================
   Clear Attendance (today)
   ====================== */
async function clearAttendanceData() {
    const confirmed = await showConfirm("Yakin ingin menghapus SEMUA data absensi hari ini?");
    if (!confirmed) return;
    const todayISO = (new Date()).toISOString().slice(0,10);
    let records = loadAttendance();
    records = records.filter(r => r.dateISO !== todayISO);
    saveAttendanceRecords(records);
    showToast("Data absensi hari ini telah dibersihkan.");
    renderAttendance();
}

/* ======================
   Modal / Toast / Confirm
   ====================== */
function showLargeQRCode(studentName) {
    DOM.largeQrCodeContainer.innerHTML = '';
    DOM.modalStudentName.textContent = studentName;
    new QRCode(DOM.largeQrCodeContainer, { text: studentName, width: 200, height: 200, colorDark: "#000", colorLight: "#fff" });
    DOM.qrModal.classList.remove('hidden');
}

function showToast(message, isError = false) {
    DOM.toastMessage.textContent = message;
    DOM.toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg text-sm transition-all duration-300 z-50 ${isError ? 'bg-red-600' : 'bg-green-600'} show`;
    setTimeout(() => { DOM.toast.classList.remove('show'); }, 3000);
}

function showConfirm(message) {
    return new Promise((resolve) => {
        confirmPromiseResolve = resolve;
        DOM.confirmModalMessage.textContent = message;
        DOM.confirmModal.classList.remove('hidden');
    });
}

/* ======================
   Setup & Events
   ====================== */
document.addEventListener('DOMContentLoaded', () => {
    populateClassSelects();
    renderAttendance();
    renderStudentList();

    // Setup tabs
    DOM.tabs.forEach((tab, index) => tab.addEventListener('click', () => {
        DOM.tabs.forEach(t => t.className = "inline-block p-4 border-b-2 rounded-t-lg border-transparent hover:text-gray-300 hover:border-gray-500");
        DOM.contents.forEach(c => c.classList.add('hidden'));
        tab.className = "inline-block p-4 border-b-2 rounded-t-lg text-blue-500 border-blue-500";
        DOM.contents[index].classList.remove('hidden');
        if (tab === DOM.tabs[0]) startScan(); else stopScan();
    }));
    DOM.tabs[0].click();

    // Scanner init (create instance but start when tab clicked)
    try { html5QrcodeScanner = new Html5Qrcode("reader"); } catch (e) { DOM.statusMessage.textContent = "Error: Gagal memuat library scanner."; }

    // Buttons & controls
    DOM.clearButton.addEventListener('click', clearAttendanceData);
    DOM.exportButton.addEventListener('click', exportToExcel);
    DOM.classSelect.addEventListener('change', renderAttendance);
    DOM.viewClassSelect.addEventListener('change', renderStudentList);

    DOM.addStudentForm.addEventListener('submit', handleAddStudent);

    DOM.importFile.addEventListener('change', () => { DOM.importButton.disabled = !DOM.importFile.files.length; });
    DOM.importButton.addEventListener('click', handleImport);

    DOM.exportStudentsButton.addEventListener('click', exportStudentDataWithQRCodes);

    DOM.studentListBody.addEventListener('click', (e) => {
        const qrButton = e.target.closest('.qr-code-button');
        const deleteButton = e.target.closest('.delete-student-button');
        if (qrButton) showLargeQRCode(qrButton.dataset.name);
        else if (deleteButton) handleDeleteStudent(deleteButton.dataset.name);
    });

    DOM.closeModalButton.addEventListener('click', () => DOM.qrModal.classList.add('hidden'));
    DOM.qrModal.addEventListener('click', (e) => { if (e.target === DOM.qrModal) DOM.qrModal.classList.add('hidden'); });

    DOM.confirmModalOK.addEventListener('click', () => { DOM.confirmModal.classList.add('hidden'); if (confirmPromiseResolve) confirmPromiseResolve(true); });
    DOM.confirmModalCancel.addEventListener('click', () => { DOM.confirmModal.classList.add('hidden'); if (confirmPromiseResolve) confirmPromiseResolve(false); });
});

/* ======================
   Small UX niceties
   ====================== */
// keep student's class selects synced when adding new class via typing (support creating new class)
document.getElementById('student-class').addEventListener('focus', (e) => {
    // populate with existing plus sample
    const students = loadStudents();
    const classNames = Object.keys(students).sort();
    const sel = DOM.studentClassSelect;
    sel.innerHTML = `<option value="">- Pilih / Ketik Kelas -</option>${classNames.map(c => `<option value="${c}">${c.replace('KELAS_','Kelas ')}</option>`).join('')}`;
});

/* ======================
   Initial small setup (if no data)
   ====================== */
(function ensureInitialized() {
    loadStudents(); // will seed if empty
})();
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').then(reg => {
      console.log('SW registered', reg.scope);
    }).catch(err => console.warn('SW failed', err));
  });
}
</script>
</body>
</html>
